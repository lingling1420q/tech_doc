文章来源于：
Redis源码从哪里读起？
https://cloud.tencent.com/developer/article/1408753

我整理下我的理解：

## 初始化流程

![](./media//202007/2020-07-13_220606.png)

1. 加载配置文件的配置，监听端口号配置等
2. 创建事件池，利用i/o多路复用方式
3. 监听端口，redis操作的端口，如果是集群，还有redis服务间互相通信端口
4. 注册定时任务，如定时持久化，过期key回收
5. 注册i/o事件回调，来响应客户端请求和集群间通信
6. 初始化一些后台线程，用于执行一些耗时的操作
7. 启动事件循环，开始响应客户端操作

## 事件循环

![](./media//202007/2020-07-13_221620.png)

事件循环是一个无限阻塞循环。
有任务执行任务，没有任务阻塞（图中"等待事件发生"）等待i/o的回调。

1. 查找最近的timer事件: 出最近需要执行的那次timer事件。这样事件循环在接下来的等待中就知道该等待多长时间
2. 等待事件发生: 阻塞线程，并且有阻塞超时时间。会被i/o事件或者超时唤醒。i/o事件就是客户端的一些set，get操作，还有集群间的同步。
3. 执行定时任务，然后进行下一轮循环

redis 的主线程（单线程）就是在处理这个循环。单线程的好处，就是不用担心线程安全。

## 命令请求的处理流程
Redis客户端向服务器发送命令，其实可以细分为两个过程：
1. 连接建立
2. 命令发送、执行和响应

### 连接建立
![](./media//202007/2020-07-13_224411.png)

Redis服务器每收到一个新的连接请求，就会由事件循环触发一个I/O事件，从而执行到acceptTcpHandler或acceptUnixHandler回调函数的代码。
从上面流程图可以看出，新的连接注册了一个I/O事件回调，即readQueryFromClient

### 命令发送、执行和响应
当服务器收到命令数据的时候，也会由事件循环触发一个I/O事件，执行到readQueryFromClient回调。

![](./media//202007/2020-07-13_224710.png)

从socket中读入数据（流式数据），解析出客户端命令。
